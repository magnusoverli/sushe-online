(()=>{const Pe=function(){let e=null,n=null,t=null,r=null,o=null,s=0,a=1,i=null;function l(){const p=document.getElementById("albumContainer");p&&(console.debug("DragDropManager: initialize",{containerFound:!!p}),p.addEventListener("dragover",f),p.addEventListener("dragleave",x))}function c(p,v){o&&clearInterval(o),console.debug("DragDropManager: startAutoScroll",{direction:p,speed:v}),s=v,a=1,o=setInterval(()=>{if(i){a<2.5&&(a+=.05);const E=s*a,C=i.scrollTop+p*E;if(console.debug("DragDropManager: autoScroll tick",{adjustedSpeed:E,newScroll:C}),p>0){const A=i.scrollHeight-i.clientHeight;i.scrollTop=Math.min(C,A),i.scrollTop>=A&&d()}else i.scrollTop=Math.max(C,0),i.scrollTop<=0&&d()}},16)}function d(){o&&(clearInterval(o),o=null,s=0,a=1,console.debug("DragDropManager: stopAutoScroll"))}function g(p){if(p.target.tagName==="TEXTAREA"||p.target.tagName==="SELECT"||p.target.tagName==="INPUT"){p.preventDefault();return}console.debug("DragDropManager: drag start",{index:this.dataset.index,clientX:p.clientX,clientY:p.clientY}),e=this,n=parseInt(this.dataset.index),i=this.closest(".overflow-y-auto")||document.getElementById("albumContainer").parentElement,t=document.createElement("div"),t.className="album-row drag-placeholder album-grid gap-4 px-4 py-3 border-b border-gray-800",t.style.height=this.offsetHeight+"px",console.debug("DragDropManager: placeholder created",{height:this.offsetHeight}),this.classList.add("dragging"),p.dataTransfer.effectAllowed="move",p.dataTransfer.setData("text/html",this.innerHTML),requestAnimationFrame(()=>{this.style.display="none",this.parentNode.insertBefore(t,this.nextSibling),console.debug("DragDropManager: placeholder inserted")})}function f(p){p.preventDefault(),p.dataTransfer.dropEffect="move",console.debug("DragDropManager: container drag over");const v=this.querySelector(".album-rows-container")||this;if(i){const b=p.clientY,C=window.innerHeight,A=i.getBoundingClientRect(),L=Math.max(80,C*.2),_=Math.max(A.top,0),ee=Math.min(A.bottom,C),te=_+L,z=ee-L;let P=!1,Y=0,K=0;if(b<te&&b>=_){P=!0,Y=-1;const he=(te-b)/L;K=Math.max(3,Math.min(20,he*20)),b<_+30&&(K=Math.min(30,K*1.5))}else if(b>z&&b<=ee){P=!0,Y=1;const he=(b-z)/L;K=Math.max(3,Math.min(20,he*20)),b>ee-30&&(K=Math.min(30,K*1.5))}P?c(Y,K):d()}const E=w(v,p.clientY);console.debug("DragDropManager: afterElement",{afterElementIndex:E?E.dataset.index:null,clientY:p.clientY}),!(!t||!t.parentNode)&&(E==null?(v.appendChild(t),r=v.children.length-1,console.debug("DragDropManager: appended placeholder",{lastValidDropIndex:r})):(v.insertBefore(t,E),r=Array.from(v.children).indexOf(t),console.debug("DragDropManager: inserted placeholder",{lastValidDropIndex:r})),this.classList.add("drag-active"))}function x(p){const v=this.getBoundingClientRect();(p.clientX<v.left||p.clientX>v.right||p.clientY<v.top||p.clientY>v.bottom)&&(this.classList.remove("drag-active"),d(),console.debug("DragDropManager: container drag leave"))}function w(p,v){return[...p.querySelectorAll(".album-row:not(.dragging):not(.drag-placeholder)")].reduce((b,C)=>{const A=C.getBoundingClientRect(),L=v-A.top-A.height/2;return L<0&&L>b.offset?{offset:L,element:C}:b},{offset:Number.NEGATIVE_INFINITY}).element}function I(p){d(),console.debug("DragDropManager: drag end",{draggedIndex:n}),e&&(e.style.display="",e.classList.remove("dragging")),t&&t.parentNode&&(t.parentNode.removeChild(t),console.debug("DragDropManager: placeholder removed on drag end")),document.getElementById("albumContainer").classList.remove("drag-active"),e=null,n=null,t=null,r=null,i=null,console.debug("DragDropManager: state cleared after drag end")}async function N(p,v){if(p.preventDefault(),p.stopPropagation(),console.debug("DragDropManager: container drop",{draggedIndex:n,lastValidDropIndex:r}),d(),this.classList.remove("drag-active"),!e||r===null||!t)return;const E=this.querySelector(".album-rows-container")||this;let b=r;console.debug("DragDropManager: initial dropIndex",{dropIndex:b});const A=E.querySelectorAll(".album-row:not(.drag-placeholder)").length-1;if(n<b&&b--,console.debug("DragDropManager: adjusted dropIndex after drag check",{dropIndex:b}),b=Math.max(0,Math.min(b,A)),console.debug("DragDropManager: bounded dropIndex",{dropIndex:b}),b!==n)try{t&&t.parentNode&&(t.parentNode.removeChild(t),t=null,console.debug("DragDropManager: placeholder removed before inserting"));const L=Array.from(E.querySelectorAll(".album-row:not(.dragging)"));let _=null;b<L.length&&(n<b,_=L[b]),_?E.insertBefore(e,_):E.appendChild(e),console.debug("DragDropManager: element moved",{from:n,to:b}),e.style.display="",e.classList.remove("dragging"),H(E),v&&(console.debug("DragDropManager: saving",{from:n,to:b}),await v(n,b))}catch(L){console.error("Error saving reorder:",L),m("Error saving changes","error"),v&&v(null,null,!0)}else console.debug("DragDropManager: position unchanged"),t&&t.parentNode&&(t.parentNode.removeChild(t),t=null,console.debug("DragDropManager: placeholder removed (unchanged position)")),e.style.display="",e.classList.remove("dragging");e=null,n=null,r=null,i=null,console.debug("DragDropManager: cleanup after drop")}function H(p){const v=Array.from(p.querySelectorAll(".album-row:not(.drag-placeholder)"));v.forEach((E,b)=>{const C=E.querySelector(".flex.items-center.justify-center");C&&(C.textContent=b+1),E.dataset.index=b}),console.debug("DragDropManager: positions updated",{totalRows:v.length})}function B(p){p.draggable=!0,p.addEventListener("dragstart",g),p.addEventListener("dragend",I),console.debug("DragDropManager: row made draggable",{index:p.dataset.index})}return{initialize:l,makeRowDraggable:B,setupDropHandler:function(p){const v=document.getElementById("albumContainer");v&&(console.debug("DragDropManager: setup drop handler"),v._dropHandler&&v.removeEventListener("drop",v._dropHandler),v.removeEventListener("drop",N),v._dropHandler=function(E){N.call(this,E,p)},v.addEventListener("drop",v._dropHandler))}}}();window.DragDropManager=Pe;const ge="https://musicbrainz.org/ws/2",je="https://coverartarchive.org",qe="https://itunes.apple.com",Be="/api/proxy/deezer",ze="KVLT Album Manager/1.0 (https://kvlt.example.com)";let Le=0;const Ce=1100;let j="artist";const se=new Map,ae=new Map,Oe=5,Ue=3,Fe=5;class pe{constructor(n){this.batchSize=n,this.running=0,this.queue=[]}async add(n){return new Promise((t,r)=>{this.queue.push({fn:n,resolve:t,reject:r}),this.process()})}async process(){for(;this.running<this.batchSize&&this.queue.length>0;){const{fn:n,resolve:t,reject:r}=this.queue.shift();this.running++,n().then(t).catch(r).finally(()=>{this.running--,this.process()})}}}const Ge=new pe(Oe),Ye=new pe(Ue),We=new pe(Fe);let D=null,U=null,u={},q=null;const J={itunes:{attempts:0,successes:0},deezer:{attempts:0,successes:0},coverart:{attempts:0,successes:0}},ce=new Map;let V=null;function Ke(){["https://is1-ssl.mzstatic.com","https://is2-ssl.mzstatic.com","https://is3-ssl.mzstatic.com","https://is4-ssl.mzstatic.com","https://is5-ssl.mzstatic.com","https://e-cdns-images.dzcdn.net","https://coverartarchive.org"].forEach(n=>{if(!document.querySelector(`link[href="${n}"]`)){const r=document.createElement("link");r.rel="preconnect",r.href=n,r.crossOrigin="anonymous",document.head.appendChild(r)}})}async function fe(e){const t=Date.now()-Le;t<Ce&&await new Promise(o=>setTimeout(o,Ce-t)),Le=Date.now();const r=await fetch(e,{headers:{"User-Agent":ze,Accept:"application/json"}});if(!r.ok)throw new Error(`HTTP error! status: ${r.status}`);return r.json()}async function Xe(e){const n=`${ge}/artist/?query=${encodeURIComponent(e)}&fmt=json&limit=10&inc=aliases`;return(await fe(n)).artists||[]}function Ve(e,n){const t=n.toLowerCase();return e.map(r=>{let o=0;const s=He(r);return r.name.toLowerCase()===t&&(o+=100),X(r.name)||(o+=50),s.primary!==s.original&&!s.warning&&(o+=30),r.name.toLowerCase().includes(t)&&(o+=20),r.disambiguation&&r.disambiguation.toLowerCase().includes(t)&&(o+=10),{...r,_searchScore:o}}).sort((r,o)=>o._searchScore-r._searchScore)}async function Me(e){const n=`${ge}/release-group?artist=${e}&type=album|ep&fmt=json&limit=100`;let r=(await fe(n))["release-groups"]||[];const s=new Date().toISOString().split("T")[0];return r=r.filter(a=>{const i=a["primary-type"],l=a["secondary-types"]||[],c=a["first-release-date"],d=(i==="Album"||i==="EP")&&l.length===0;if(!c)return!1;let g=!0,f=c;if(c.length===4)f=`${c}-12-31`;else if(c.length===7){const[x,w]=c.split("-"),I=new Date(parseInt(x),parseInt(w),0).getDate();f=`${c}-${I.toString().padStart(2,"0")}`}return g=f<=s,d&&g}),r.sort((a,i)=>{const l=a["first-release-date"]||"0000";return(i["first-release-date"]||"0000").localeCompare(l)}),r}async function Ze(e,n){const t=`${e}::${n}`.toLowerCase();return se.has(t)?se.get(t):(J.itunes.attempts++,Ge.add(async()=>{try{const r=`${e} ${n}`.replace(/[^\w\s]/g," ").trim(),o=`${qe}/search?term=${encodeURIComponent(r)}&entity=album&limit=5`,s=await fetch(o);if(!s.ok)throw new Error("iTunes API request failed");const a=await s.json();if(a.results&&a.results.length>0){const i=n.toLowerCase().replace(/[^\w\s]/g,""),l=e.toLowerCase().replace(/[^\w\s]/g,"");let c=a.results.find(d=>{const g=(d.collectionName||"").toLowerCase().replace(/[^\w\s]/g,""),f=(d.artistName||"").toLowerCase().replace(/[^\w\s]/g,"");return g===i&&f===l});if(c||(c=a.results.find(d=>{const g=(d.collectionName||"").toLowerCase().replace(/[^\w\s]/g,"");return g.includes(i)||i.includes(g)})),c||(c=a.results[0]),c&&c.artworkUrl100){const d=c.artworkUrl100.replace("100x100","600x600");return se.set(t,d),J.itunes.successes++,d}}return se.set(t,null),null}catch(r){return console.error("iTunes search error:",r),se.set(t,null),null}}))}async function Je(e,n){const t=`${e}::${n}`.toLowerCase();return ae.has(t)?ae.get(t):(J.deezer.attempts++,We.add(async()=>{try{const r=`${e} ${n}`.replace(/[^\w\s]/g," ").trim(),o=`${Be}?q=${encodeURIComponent(r)}`,s=await fetch(o,{credentials:"same-origin"});if(!s.ok)throw new Error("Deezer proxy request failed");const a=await s.json();if(a.data&&a.data.length>0){const i=n.toLowerCase().replace(/[^\w\s]/g,""),l=e.toLowerCase().replace(/[^\w\s]/g,"");let c=a.data.find(d=>{const g=(d.title||"").toLowerCase().replace(/[^\w\s]/g,""),f=(d.artist?.name||"").toLowerCase().replace(/[^\w\s]/g,"");return g===i&&f===l});if(c||(c=a.data.find(d=>{const g=(d.title||"").toLowerCase().replace(/[^\w\s]/g,"");return g.includes(i)||i.includes(g)})),c||(c=a.data[0]),c&&c.cover_xl)return ae.set(t,c.cover_xl),J.deezer.successes++,c.cover_xl}return ae.set(t,null),null}catch(r){return console.error("Deezer search error:",r),ae.set(t,null),null}}))}async function Qe(e){return J.coverart.attempts++,Ye.add(async()=>{try{const n=await fetch(`${je}/release-group/${e}`,{headers:{Accept:"application/json"}});if(!n.ok)return null;const t=await n.json();if(t.images&&t.images.length>0){const r=t.images.find(s=>s.front)||t.images[0],o=r.thumbnails[250]||r.thumbnails.small||r.image;return J.coverart.successes++,o}return null}catch(n){return console.error("Error fetching cover art from archive:",n),null}})}async function oe(e,n,t){const r=s=>{const a=J[s];return a.attempts>0?a.successes/a.attempts:.5},o=[{name:"itunes",fn:()=>Ze(n,t),enabled:n&&t},{name:"deezer",fn:()=>Je(n,t),enabled:n&&t},{name:"coverart",fn:()=>Qe(e),enabled:!0}].filter(s=>s.enabled).sort((s,a)=>r(a.name)-r(s.name));for(const s of o)try{const a=await s.fn();if(a)return a}catch(a){console.error(`${s.name} error:`,a)}return null}async function et(e){if(ce.has(e.id))return ce.get(e.id);V&&V.abort(),V=new AbortController;try{const n=await Me(e.id);return V.signal.aborted||(ce.set(e.id,n),n.slice(0,6).forEach(async t=>{const r=await oe(t.id,e.name,t.title);if(r){const o=new Image;o.src=r}})),n}catch(n){return n.name!=="AbortError"&&console.error("Preload error:",n),null}}let Z=null,re=!1;function tt(e,n){Z&&Z.disconnect();const t=new Set,r=new Set,o=async l=>{if(t.has(l)||r.has(l))return;r.add(l);const c=u.albumList.querySelector(`[data-album-index="${l}"]`);if(!c)return;const d=c.querySelector(".album-cover-container");if(!(!d||d.dataset.loaded==="true"))try{const g=await oe(e[l].id,n,e[l].title);if(g&&!q?.signal.aborted){e[l].coverArt=g;const f=window.innerWidth<1024;d.innerHTML=`
          <img src="${g}" 
              alt="${e[l].title}" 
              class="w-16 h-16 object-cover ${f?"rounded":"rounded-full"}" 
              loading="lazy" 
              crossorigin="anonymous"
              onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'w-16 h-16 bg-gray-700 ${f?"rounded":"rounded-full"} flex items-center justify-center animate-pulse\\'><svg width=\\'24\\' height=\\'24\\' viewBox=\\'0 0 24 24\\' fill=\\'none\\' stroke=\\'currentColor\\' stroke-width=\\'1\\' class=\\'text-gray-600\\'><rect x=\\'3\\' y=\\'3\\' width=\\'18\\' height=\\'18\\' rx=\\'2\\' ry=\\'2\\'></rect><circle cx=\\'8.5\\' cy=\\'8.5\\' r=\\'1.5\\'></circle><polyline points=\\'21 15 16 10 5 21\\'></polyline></svg></div>'; delete window.currentReleaseGroups[${l}].coverArt;">
        `,d.dataset.loaded="true"}t.add(l),r.delete(l)}catch(g){console.error(`Error loading cover for ${e[l].title}:`,g),t.add(l),r.delete(l)}},s=async()=>{if(re||q?.signal.aborted)return;re=!0;const l=[];for(let d=0;d<e.length;d++)!t.has(d)&&!r.has(d)&&l.push(d);const c=3;for(let d=0;d<l.length&&!q?.signal.aborted;d+=c){const f=l.slice(d,d+c).map(x=>o(x));await Promise.allSettled(f),d+c<l.length&&await new Promise(x=>setTimeout(x,100))}re=!1};let a=0,i=0;return Z=new IntersectionObserver((l,c)=>{l.forEach(d=>{if(d.isIntersecting){const g=d.target,f=parseInt(g.dataset.albumIndex);i++,o(f).then(()=>{a++,a>=i&&a>0&&setTimeout(()=>{s()},500)}),c.unobserve(g)}})},{rootMargin:"100px",threshold:.01}),setTimeout(()=>{if(a===0){const l=Array.from(u.albumList.querySelectorAll("[data-album-index]")).filter(c=>{const d=c.getBoundingClientRect();return d.top<window.innerHeight&&d.bottom>0});Promise.all(l.map(c=>o(parseInt(c.dataset.albumIndex)))).then(()=>{s()})}},2e3),Z}async function Ae(){const e=u.artistSearchInput.value.trim();if(!e){m(`Please enter ${j==="artist"?"an artist":"an album"} name`,"error");return}Re();try{if(j==="artist"){const n=await Xe(e);if(n.length===0){u.searchLoading.classList.add("hidden"),u.searchEmpty.classList.remove("hidden"),u.searchEmpty.innerHTML="<p>No artists found. Try a different search.</p>";return}const t=Ve(n,e);await ct(t)}else{const n=await mt(e);if(n.length===0){u.searchLoading.classList.add("hidden"),u.searchEmpty.classList.remove("hidden"),u.searchEmpty.innerHTML="<p>No albums found. Try a different search.</p>";return}await nt(n)}}catch(n){console.error(`Error searching ${j}s:`,n),m(`Error searching ${j}s`,"error"),u.searchLoading.classList.add("hidden"),u.searchEmpty.classList.remove("hidden")}}async function nt(e){we(),u.albumList.innerHTML="",u.backToArtists&&(u.backToArtists.style.display="none"),window.currentReleaseGroups=e,u.albumList.className="space-y-3",re=!1;const n=new Date;n.setDate(n.getDate()-30);const t=n.toISOString().split("T")[0];for(const r of e){const o=document.createElement("div");o.dataset.albumIndex=e.indexOf(r),o.dataset.albumId=r.id;const s=r["artist-credit"]||[],i=s.map(g=>g.name||g.artist?.name||"Unknown Artist").join(", "),l=me(r["first-release-date"]),c=r["primary-type"],d=r["first-release-date"]&&r["first-release-date"]>=t;o.className="p-4 bg-gray-800 rounded-lg hover:bg-gray-700 cursor-pointer transition-all hover:shadow-lg flex items-center gap-4 relative",o.innerHTML=`
      ${d?`
        <div class="absolute top-2 right-2 bg-red-600 text-white text-xs px-2 py-1 rounded z-10 font-semibold">
          NEW
        </div>
      `:""}
      <div class="album-cover-container flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden flex items-center justify-center shadow-md">
        <div class="w-20 h-20 bg-gray-700 rounded-lg flex items-center justify-center animate-pulse">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" class="text-gray-600">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
          </svg>
        </div>
      </div>
      <div class="flex-1 min-w-0">
        <div class="font-semibold text-white truncate text-lg" title="${r.title}">${r.title}</div>
        <div class="text-sm text-gray-400 mt-1">${l} \u2022 ${c}</div>
        <div class="text-xs text-gray-500 mt-1">${i}</div>
      </div>
    `,r._artistDisplay=i,r._artistCredit=s[0],o.onclick=async()=>{const g=o.querySelector(".album-cover-container");g.innerHTML=`
        <div class="w-20 h-20 bg-gray-700 rounded-lg flex items-center justify-center">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
        </div>
      `;const f=s[0],x=await ut(s);if(D={name:i,id:f?.artist?.id||null,country:x},!r.coverArt)try{const w=await oe(r.id,D.name,r.title);w&&(r.coverArt=w)}catch(w){console.error("Error loading cover before add:",w)}Ne(r)},u.albumList.appendChild(o),requestAnimationFrame(()=>{oe(r.id,i,r.title).then(g=>{if(g&&!q?.signal.aborted){r.coverArt=g;const f=o.querySelector(".album-cover-container");f&&(f.innerHTML=`
              <img src="${g}" 
                  alt="${r.title}" 
                  class="w-20 h-20 object-cover rounded-lg" 
                  loading="lazy" 
                  crossorigin="anonymous"
                  onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'w-20 h-20 bg-gray-700 rounded-lg flex items-center justify-center\\'>\\
                    <svg width=\\'24\\' height=\\'24\\' viewBox=\\'0 0 24 24\\' fill=\\'none\\' stroke=\\'currentColor\\' stroke-width=\\'1\\' class=\\'text-gray-600\\'>\\
                      <rect x=\\'3\\' y=\\'3\\' width=\\'18\\' height=\\'18\\' rx=\\'2\\' ry=\\'2\\'></rect>\\
                      <circle cx=\\'8.5\\' cy=\\'8.5\\' r=\\'1.5\\'></circle>\\
                      <polyline points=\\'21 15 16 10 5 21\\'></polyline>\\
                    </svg>\\
                  </div>';">
            `)}})})}}function rt(){if(U=document.getElementById("addAlbumModal"),!U){console.error("Add album modal not found");return}u={artistSearchInput:document.getElementById("artistSearchInput"),searchArtistBtn:document.getElementById("searchArtistBtn"),closeModalBtn:document.getElementById("closeModalBtn"),closeModalBtnDesktop:document.getElementById("closeModalBtnDesktop"),artistResults:document.getElementById("artistResults"),albumResults:document.getElementById("albumResults"),artistList:document.getElementById("artistList"),albumList:document.getElementById("albumList"),searchLoading:document.getElementById("searchLoading"),searchEmpty:document.getElementById("searchEmpty"),backToArtists:document.getElementById("backToArtists"),searchSection:document.getElementById("searchSection"),manualEntryBtn:document.getElementById("manualEntryBtn"),manualEntryForm:document.getElementById("manualEntryForm"),backToSearch:document.getElementById("backToSearch"),form:document.getElementById("manualAlbumForm"),coverArtInput:document.getElementById("manualCoverArt"),coverPreview:document.getElementById("coverPreview"),countrySelect:document.getElementById("manualCountry"),cancelBtn:document.getElementById("cancelManualEntry")};const n=["closeModalBtn","searchArtistBtn","artistSearchInput"].filter(s=>!u[s]&&s!=="closeModalBtnDesktop");if(n.length>0){console.error("Missing essential modal elements:",n);return}(()=>{u.closeModalBtn&&(u.closeModalBtn.onclick=ne),u.closeModalBtnDesktop&&(u.closeModalBtnDesktop.onclick=ne)})(),U.onclick=s=>{s.target===U&&window.innerWidth>=1024&&ne()},u.searchArtistBtn.onclick=Ae,u.artistSearchInput.onkeypress=s=>{s.key==="Enter"&&Ae()},u.backToArtists&&(u.backToArtists.onclick=()=>{q&&(q.abort(),q=null),be(),u.albumResults.classList.add("hidden")}),u.manualEntryBtn&&(u.manualEntryBtn.onclick=st),u.backToSearch&&(u.backToSearch.onclick=Ie),u.cancelBtn&&(u.cancelBtn.onclick=Ie),u.form&&(u.form.onsubmit=it),u.coverArtInput&&(u.coverArtInput.onchange=at),document.querySelectorAll(".search-mode-btn").forEach(s=>{s.onclick=()=>Te(s.dataset.mode)}),ye(),document.addEventListener("keydown",s=>{s.key==="Escape"&&!U.classList.contains("hidden")&&window.innerWidth>=1024&&ne()});let o;window.addEventListener("resize",()=>{clearTimeout(o),o=setTimeout(()=>{if(!U.classList.contains("hidden")){const s=window.innerWidth<1024;U.style.overflow=s?"hidden":""}},250)})}function Te(e){j=e,document.querySelectorAll(".search-mode-btn").forEach(o=>{const s=o.dataset.mode===e;o.classList.toggle("active",s),o.classList.toggle("bg-gray-700",s),o.classList.toggle("text-white",s),o.classList.toggle("text-gray-400",!s)});const n=e==="artist"?"Search for an artist...":"Search for an album...";u.artistSearchInput&&(u.artistSearchInput.placeholder=n);const t=e==="artist"?"Search Artists":"Search Albums",r=window.innerWidth<1024;u.searchArtistBtn&&(u.searchArtistBtn.innerHTML=r?'<i class="fas fa-search mr-2"></i>Search':`<i class="fas fa-search mr-2"></i>${t}`),ot()}function ot(){u.artistResults.classList.add("hidden"),u.albumResults.classList.add("hidden"),u.searchLoading.classList.add("hidden"),u.searchEmpty.classList.remove("hidden"),u.artistList.innerHTML="",u.albumList.innerHTML=""}window.openAddAlbumModal=function(){if(!h){m("Please select a list first","error");return}Ke(),U.classList.remove("hidden"),j="artist",Te("artist"),u.artistSearchInput&&(u.artistSearchInput.value="",setTimeout(()=>u.artistSearchInput.focus(),100)),De(),ye(),window.innerWidth<1024&&(document.body.style.overflow="hidden")};function st(){u.artistResults.classList.add("hidden"),u.albumResults.classList.add("hidden"),u.searchLoading.classList.add("hidden"),u.searchEmpty.classList.add("hidden");const e=document.getElementById("searchSection");e&&e.classList.add("hidden"),u.manualEntryForm.classList.remove("hidden"),u.form.reset(),ve(),ye()}function Ie(){u.manualEntryForm.classList.add("hidden"),u.searchEmpty.classList.remove("hidden");const e=document.getElementById("searchSection");e&&e.classList.remove("hidden"),u.form.reset(),ve()}function ye(){const e=u.countrySelect;if(e){for(;e.options.length>1;)e.remove(1);typeof R<"u"&&R&&R.forEach(n=>{const t=document.createElement("option");t.value=n,t.textContent=n,e.appendChild(t)})}}function ve(){const e=window.innerWidth<1024?'<i class="fas fa-image text-2xl text-gray-600"></i>':`<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" class="text-gray-600">
        <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
        <circle cx="8.5" cy="8.5" r="1.5"></circle>
        <polyline points="21 15 16 10 5 21"></polyline>
      </svg>`;u.coverPreview.innerHTML=e}async function at(e){const n=e.target.files[0];if(!n)return;if(n.size>5*1024*1024){m("Image file size must be less than 5MB","error"),e.target.value="";return}if(!n.type.startsWith("image/")){m("Please select a valid image file","error"),e.target.value="";return}const t=new FileReader;t.onload=function(r){u.coverPreview.innerHTML=`
      <img src="${r.target.result}" alt="Cover preview" class="w-full h-full object-cover rounded">
    `},t.readAsDataURL(n)}async function it(e){e.preventDefault();const n=new FormData(u.form),t=n.get("artist").trim(),r=n.get("album").trim();if(!t||!r){m("Artist and Album title are required","error");return}const o={artist:t,album:r,album_id:"manual-"+Date.now(),release_date:n.get("release_date")||"",country:n.get("country")||"",genre_1:"",genre_2:"",comments:""},s=n.get("cover_art");if(s&&s.size>0){m("Processing cover art...","info");try{const a=new FileReader;a.onloadend=async function(){const i=a.result;o.cover_image=i.split(",")[1],o.cover_image_format=s.type.split("/")[1].toUpperCase(),await $e(o)},a.onerror=function(){console.error("Error reading cover art"),m("Error processing cover art","error")},a.readAsDataURL(s)}catch(a){console.error("Error processing cover art:",a),m("Error processing cover art","error")}}else await $e(o)}async function $e(e){try{y[h].push(e),await S(h,y[h]),k(h),ne(),m(`Added "${e.album}" by ${e.artist} to the list`)}catch(n){console.error("Error adding manual album:",n),m("Error adding album to list","error"),y[h].pop()}}function ne(){q&&(q.abort(),q=null),V&&(V.abort(),V=null),re=!1,Z&&(Z.disconnect(),Z=null),U.classList.add("hidden"),De(),window.innerWidth<1024&&(document.body.style.overflow="")}function De(){u.artistResults.classList.add("hidden"),u.albumResults.classList.add("hidden"),u.searchLoading.classList.add("hidden"),u.searchEmpty.classList.remove("hidden"),u.artistList.innerHTML="",u.albumList.innerHTML="",document.querySelectorAll(".search-mode-btn").forEach(t=>{t.classList.toggle("active",t.dataset.mode===j),t.classList.toggle("bg-gray-700",t.dataset.mode===j),t.classList.toggle("text-white",t.dataset.mode===j),t.classList.toggle("text-gray-400",t.dataset.mode!==j)});const e=j==="artist"?"Search for an artist...":"Search for an album...";u.artistSearchInput&&(u.artistSearchInput.placeholder=e);const n=document.getElementById("searchSection");n&&n.classList.remove("hidden"),u.manualEntryForm&&(u.manualEntryForm.classList.add("hidden"),u.form&&u.form.reset(),ve()),D=null}function Re(){u.artistResults.classList.add("hidden"),u.albumResults.classList.add("hidden"),u.searchEmpty.classList.add("hidden"),u.searchLoading.classList.remove("hidden")}function be(){u.searchLoading.classList.add("hidden"),u.searchEmpty.classList.add("hidden"),u.albumResults.classList.add("hidden"),u.artistResults.classList.remove("hidden")}function we(){u.searchLoading.classList.add("hidden"),u.artistResults.classList.add("hidden"),u.albumResults.classList.remove("hidden")}async function lt(e){try{const n=e.replace(/[^\w\s]/g," ").trim(),t=`${Be}?q=${encodeURIComponent(n)}`,r=await fetch(t,{credentials:"same-origin"});if(!r.ok)return null;const o=await r.json();if(o.data&&o.data.length>0){const s=new Map;if(o.data.forEach(a=>{if(a.artist&&a.artist.picture_medium){const i=a.artist.name.toLowerCase(),l=e.toLowerCase();i===l?s.set(a.artist.name,a.artist.picture_medium):(i.includes(l)||l.includes(i))&&(s.has(a.artist.name)||s.set(a.artist.name,a.artist.picture_medium))}}),s.size>0)return s.values().next().value}return null}catch(n){return console.error("Error fetching artist image:",n),null}}async function ct(e){u.artistList.innerHTML="",u.artistList.className="space-y-3";for(const n of e){const t=document.createElement("div");t.className="p-4 bg-gray-800 rounded-lg hover:bg-gray-700 cursor-pointer transition-colors flex items-center gap-4";const r=He(n);let o="";r.secondary&&(o=r.secondary),n.disambiguation&&n.disambiguation!==r.secondary&&n.disambiguation!==r.primary&&(o+=o?` \u2022 ${n.disambiguation}`:n.disambiguation);let s="";n.country&&(s=` \u2022 ${await xe(n.country)||n.country}`),t.innerHTML=`
      <div class="artist-image-container flex-shrink-0">
        <div class="w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-600">
            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
            <circle cx="12" cy="7" r="4"></circle>
          </svg>
        </div>
      </div>
      <div class="flex-1 min-w-0">
        <div class="font-medium text-white">
          ${r.primary}
          ${r.warning?'<i class="fas fa-exclamation-triangle text-yellow-500 text-xs ml-2" title="Non-Latin script - no Latin version found"></i>':""}
        </div>
        ${o?`<div class="text-sm text-gray-400 mt-1">${o}</div>`:""}
        <div class="text-sm text-gray-400 mt-1">${n.type||"Artist"}${s}</div>
      </div>
      <div class="flex-shrink-0">
        <i class="fas fa-chevron-right text-gray-500"></i>
      </div>
    `;const a={...n,_displayName:r},i=r.original&&!r.warning?r.primary:n.name;lt(i).then(c=>{if(c){const d=t.querySelector(".artist-image-container");d.innerHTML=`
          <img 
            src="${c}" 
            alt="${r.primary}" 
            class="w-16 h-16 rounded-full object-cover"
            onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'w-16 h-16 bg-gray-700 rounded-full flex items-center justify-center\\'><svg width=\\'24\\' height=\\'24\\' viewBox=\\'0 0 24 24\\' fill=\\'none\\' stroke=\\'currentColor\\' stroke-width=\\'2\\' class=\\'text-gray-600\\'><path d=\\'M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2\\'></path><circle cx=\\'12\\' cy=\\'7\\' r=\\'4\\'></circle></svg></div>'"
          >
        `}});let l;t.addEventListener("mouseenter",()=>{l=setTimeout(()=>{et(n)},300)}),t.addEventListener("mouseleave",()=>{clearTimeout(l)}),t.onclick=()=>dt(a),u.artistList.appendChild(t)}be()}async function dt(e){D=e._displayName?{...e,name:e._displayName.primary,originalName:e.name}:e,Re(),q=new AbortController;try{let n=ce.get(e.id);if(n||(n=await Me(e.id)),n.length===0){m("No pure albums or EPs found for this artist","error"),we(),u.albumList.innerHTML='<p class="col-span-full text-center text-gray-500">No standard albums or EPs found.</p>';return}gt(n)}catch(n){if(n.name==="AbortError"){console.log("Album loading cancelled");return}console.error("Error fetching albums:",n),m("Error fetching albums","error"),be()}}async function xe(e){if(!e||e.length!==2)return"";try{const n=await fetch(`https://restcountries.com/v3.1/alpha/${e}`);if(!n.ok)return console.warn(`Country code ${e} not found`),"";const t=await n.json();if(!t||!t[0])return"";const r=t[0],o=[r.name.common,r.name.official,...r.altSpellings||[]];e==="US"?o.push("United States"):e==="GB"?o.push("United Kingdom"):e==="KR"?o.push("Korea, South"):e==="KP"&&o.push("Korea, North");for(const i of o)if(i&&R.includes(i))return i;const s=r.name.common.toLowerCase(),a=R.find(i=>{const l=i.toLowerCase();return l===s||l.includes(s)||s.includes(l)});return a||(console.warn(`Country "${r.name.common}" (${e}) not found in allowed countries list`),"")}catch(n){return console.error("Error resolving country code:",n),""}}async function ut(e){const n=[];for(const t of e){const r=t.artist?.id;if(r)try{const o=await fe(`${ge}/artist/${r}?fmt=json`);if(o&&o.country){const s=await xe(o.country);s&&!n.includes(s)&&n.push(s)}}catch(o){console.error("Error fetching artist country:",o)}}return n.join(" / ")}async function mt(e){const n=`${ge}/release-group/?query=${encodeURIComponent(e)}&type=album|ep&fmt=json&limit=20`;let r=(await fe(n))["release-groups"]||[];const s=new Date().toISOString().split("T")[0];return r=r.filter(a=>{const i=a["primary-type"],l=a["secondary-types"]||[],c=a["first-release-date"],d=(i==="Album"||i==="EP")&&l.length===0;if(!c)return!1;let g=c;if(c.length===4)g=`${c}-12-31`;else if(c.length===7){const[f,x]=c.split("-"),w=new Date(parseInt(f),parseInt(x),0).getDate();g=`${c}-${w.toString().padStart(2,"0")}`}return d&&g<=s}),r.sort((a,i)=>{const l=a["first-release-date"]||"0000";return(i["first-release-date"]||"0000").localeCompare(l)}),r}function gt(e){we(),u.albumList.innerHTML="",window.currentReleaseGroups=e,u.albumList.className="space-y-3",re=!1;const n=new Date;n.setDate(n.getDate()-30);const t=n.toISOString().split("T")[0],r=tt(e,D.name);e.forEach((o,s)=>{const a=document.createElement("div");a.dataset.albumIndex=s,a.dataset.albumId=o.id;const i=me(o["first-release-date"]),l=o["primary-type"],c=o["first-release-date"]&&o["first-release-date"]>=t;a.className="p-4 bg-gray-800 rounded-lg hover:bg-gray-700 cursor-pointer transition-all hover:shadow-lg flex items-center gap-4 relative",a.innerHTML=`
      ${c?`
        <div class="absolute top-2 right-2 bg-red-600 text-white text-xs px-2 py-1 rounded z-10 font-semibold">
          NEW
        </div>
      `:""}
      <div class="album-cover-container flex-shrink-0 w-20 h-20 rounded-lg overflow-hidden flex items-center justify-center shadow-md">
        <div class="w-20 h-20 bg-gray-700 rounded-lg flex items-center justify-center animate-pulse">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1" class="text-gray-600">
            <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
            <circle cx="8.5" cy="8.5" r="1.5"></circle>
            <polyline points="21 15 16 10 5 21"></polyline>
          </svg>
        </div>
      </div>
      <div class="flex-1 min-w-0">
        <div class="font-semibold text-white truncate text-lg" title="${o.title}">${o.title}</div>
        <div class="text-sm text-gray-400 mt-1">${i} \u2022 ${l}</div>
        <div class="text-xs text-gray-500 mt-1">${D.name}</div>
      </div>
    `,a.onclick=async()=>{const d=a.querySelector(".album-cover-container");d.innerHTML=`
        <div class="w-20 h-20 bg-gray-700 rounded-lg flex items-center justify-center">
          <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-white"></div>
        </div>
      `;const g=a.querySelector(".album-cover-container img");if(g&&g.src&&!g.src.includes("data:image/svg")&&!o.coverArt&&(o.coverArt=g.src),!o.coverArt)try{const f=await oe(o.id,D.name,o.title);f&&(o.coverArt=f)}catch(f){console.error("Error loading cover before add:",f)}Ne(o)},u.albumList.appendChild(a),r.observe(a)}),window.currentReleaseGroups=e,requestAnimationFrame(()=>{Array.from(u.albumList.querySelectorAll("[data-album-index]")).filter(s=>{const a=s.getBoundingClientRect();return a.top<window.innerHeight&&a.bottom>0}).forEach(s=>{r&&(r.unobserve(s),r.observe(s))})})}async function Ne(e){m("Adding album...","info");let n="";D.country&&(D.country.length===2?n=await xe(D.country):n=D.country);const t={artist:D.name,album:e.title,album_id:e.id,release_date:e["first-release-date"]||"",country:n,genre_1:"",genre_2:"",comments:""};let r=e.coverArt;if(!r){const o=document.querySelectorAll("[data-album-index]");for(let s of o)if(parseInt(s.dataset.albumIndex)===releaseGroups.indexOf(e)){const a=s.querySelector(".album-cover-container img");if(a&&a.src&&!a.src.includes("data:image/svg")){r=a.src,e.coverArt=r;break}}}if(!r){m("Fetching album cover...","info");try{r=await oe(e.id,D.name,e.title),r&&(e.coverArt=r)}catch(o){console.error("Error fetching cover art:",o)}}if(r)try{const s=await(await fetch(r)).blob();if(!s.type.startsWith("image/"))throw new Error("Invalid image type");const a=new FileReader;a.onloadend=function(){const i=a.result;t.cover_image=i.split(",")[1],t.cover_image_format=s.type.split("/")[1].toUpperCase(),le(t)},a.onerror=function(){console.error("Error reading cover art"),le(t)},a.readAsDataURL(s)}catch(o){console.error("Error fetching cover art:",o),le(t)}else le(t)}async function le(e){try{y[h].push(e),await S(h,y[h]),k(h),ne(),m(`Added "${e.album}" by ${e.artist} to the list`)}catch(n){console.error("Error adding album:",n),m("Error adding album to list","error"),y[h].pop()}}function X(e){if(!e)return!1;const n=e.match(/\p{L}/gu)||[],t=e.match(/[^\u0000-\u024F\u1E00-\u1EFF]/gu)||[];return n.length>0&&t.length/n.length>.5}function ft(e){let n=null;if(e["sort-name"]&&e["sort-name"]!==e.name&&!X(e["sort-name"])){const t=e["sort-name"];if(t.includes(",")){const r=t.split(",").map(o=>o.trim());r.length===2?n=`${r[1]} ${r[0]}`:n=t}else n=t}if(!n&&e.name){const t=e.name.match(/\(([^)]+)\)/);if(t){const r=t[1].trim();X(r)||(n=r)}}if(!n&&e.disambiguation&&(X(e.disambiguation)||(!e.disambiguation.includes(" ")||e.disambiguation.split(" ").length<=3)&&!e.disambiguation.toLowerCase().includes("group")&&!e.disambiguation.toLowerCase().includes("band")&&(n=e.disambiguation)),!n&&e.aliases&&Array.isArray(e.aliases)){for(const t of e.aliases)if(t.name&&!X(t.name)&&(t.primary||t.type==="Artist name")){n=t.name;break}if(!n){const t=e.aliases.find(r=>r.name&&!X(r.name));t&&(n=t.name)}}return n}function He(e){if(!X(e.name))return{primary:e.name,secondary:e.disambiguation||null,original:e.name};const t=ft(e);return t?{primary:t,secondary:e.name,original:e.name}:{primary:e.name,secondary:"Non-Latin script",original:e.name,warning:!0}}document.addEventListener("DOMContentLoaded",()=>{rt()});let h=null,y={},W=null,F=[],R=[],M=null,$=null,ue=null,T=null,O=null;const ht={1:60,2:54,3:50,4:46,5:43,6:40,7:38,8:36,9:34,10:32,11:30,12:29,13:28,14:27,15:26,16:25,17:24,18:23,19:22,20:21,21:20,22:19,23:18,24:17,25:16,26:15,27:14,28:13,29:12,30:11,31:10,32:9,33:8,34:7,35:6,36:5,37:4,38:3,39:2,40:1};window.selectList=k;document.addEventListener("click",()=>{const e=document.getElementById("contextMenu");e&&e.classList.add("hidden");const n=document.getElementById("albumContextMenu");n&&n.classList.add("hidden")});document.addEventListener("contextmenu",e=>{e.target.closest("#listNav button")&&e.preventDefault()});function pt(e){return ht[e]||1}function yt(e,n,t,r="Confirm",o=null){const s=document.getElementById("confirmationModal"),a=document.getElementById("confirmationTitle"),i=document.getElementById("confirmationMessage"),l=document.getElementById("confirmationSubMessage"),c=document.getElementById("confirmationConfirmBtn");a.textContent=e,i.textContent=n,l.textContent=t||"",c.textContent=r,ue=o,s.classList.remove("hidden"),setTimeout(()=>c.focus(),100)}function ie(){document.getElementById("confirmationModal").classList.add("hidden"),ue=null}function vt(e,n){const t=document.getElementById("serviceSelectModal"),r=document.getElementById("serviceSpotifyBtn"),o=document.getElementById("serviceTidalBtn"),s=document.getElementById("serviceCancelBtn");return!t||!r||!o||!s?Promise.resolve(null):(r.classList.toggle("hidden",!e),o.classList.toggle("hidden",!n),t.classList.remove("hidden"),new Promise(a=>{const i=()=>{t.classList.add("hidden"),r.onclick=null,o.onclick=null,s.onclick=null,t.onclick=null,document.removeEventListener("keydown",l)},l=c=>{c.key==="Escape"&&(i(),a(null))};r.onclick=()=>{i(),a("spotify")},o.onclick=()=>{i(),a("tidal")},s.onclick=()=>{i(),a(null)},t.onclick=c=>{c.target===t&&(i(),a(null))},document.addEventListener("keydown",l)}))}function me(e){if(!e)return"";let n;try{if(/^\d{4}$/.test(e))return e;if(/^\d{4}-\d{2}$/.test(e)){const[t,r]=e.split("-");return`${r}-${t}`}if(/^\d{4}-\d{2}-\d{2}$/.test(e)){const[t,r,o]=e.split("-");return`${o}-${r}-${t}`}if(/^\d{1,2}[/-]\d{1,2}[/-]\d{4}$/.test(e)){const t=e.split(/[/-]/),r=t[0].padStart(2,"0"),o=t[1].padStart(2,"0"),s=t[2];return`${o}-${r}-${s}`}if(/^\d{1,2}[/-]\d{1,2}[/-]\d{4}$/.test(e)){const t=e.split(/[/-]/),r=parseInt(t[0]),o=parseInt(t[1]);if(r>12){const s=t[0].padStart(2,"0"),a=t[1].padStart(2,"0"),i=t[2];return`${s}-${a}-${i}`}else if(o>12){const s=t[0].padStart(2,"0"),a=t[1].padStart(2,"0"),i=t[2];return`${a}-${s}-${i}`}else{const s=t[0].padStart(2,"0"),a=t[1].padStart(2,"0"),i=t[2];return`${s}-${a}-${i}`}}if(n=new Date(e),!isNaN(n.getTime())){const t=n.getDate().toString().padStart(2,"0"),r=(n.getMonth()+1).toString().padStart(2,"0"),o=n.getFullYear();return`${t}-${r}-${o}`}return e}catch{return e}}async function bt(){try{if(R=(await(await fetch("/countries.txt")).text()).split(`
`).map(t=>t.trim()).filter((t,r,o)=>t.length>0||r===0&&t===""),R[0]!=="")R.sort();else{const t=R.shift();R.sort(),R.unshift(t)}}catch(e){console.error("Error loading countries:",e),m("Error loading countries","error")}}async function wt(e){try{const n=y[e];if(!n){m("List not found","error");return}const t=n.map((c,d)=>{const g={...c};return g.rank=d+1,g.points=pt(d+1),g}),r=JSON.stringify(t,null,2),o=new Blob([r],{type:"application/json"}),s=`${e}.json`;if(/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)&&navigator.share)try{const c=new File([o],s,{type:"application/json"});if(navigator.canShare&&navigator.canShare({files:[c]})){await navigator.share({files:[c],title:e,text:`Album list export: ${e}`}),m("List shared successfully");return}}catch(c){console.log("Share API failed, falling back to download:",c)}const i=URL.createObjectURL(o),l=document.createElement("a");l.href=i,l.download=s,window.navigator.userAgent.match(/iPhone|iPad|iPod/i)&&(l.target="_blank",l.rel="noopener noreferrer"),document.body.appendChild(l),l.click(),setTimeout(()=>{document.body.removeChild(l),URL.revokeObjectURL(i)},100),m(`Downloaded "${e}"`)}catch(n){console.error("Error downloading/sharing list:",n),m("Error downloading list","error")}}function xt(){const e=document.getElementById("importConflictModal"),n=document.getElementById("importRenameModal"),t=document.getElementById("conflictListName"),r=document.getElementById("originalImportName"),o=document.getElementById("importNewName");document.getElementById("importOverwriteBtn").onclick=async()=>{if(!(!M||!$)){e.classList.add("hidden");try{await S($,M),G(),k($),m(`Overwritten "${$}" with ${M.length} albums`)}catch(s){console.error("Import overwrite error:",s),m("Error overwriting list","error")}M=null,$=null}},document.getElementById("importRenameBtn").onclick=()=>{e.classList.add("hidden"),r.textContent=$;let s=$,a=1;for(;y[s];)s=`${$} (${a})`,a++;o.value=s,n.classList.remove("hidden"),setTimeout(()=>{o.focus(),o.select()},100)},document.getElementById("importMergeBtn").onclick=async()=>{if(!(!M||!$)){e.classList.add("hidden");try{const s=y[$]||[],a=new Set(s.map(g=>`${g.artist}::${g.album}`.toLowerCase())),i=M.filter(g=>{const f=`${g.artist}::${g.album}`.toLowerCase();return!a.has(f)}),l=[...s,...i];await S($,l),G(),k($);const c=i.length,d=M.length-c;d>0?m(`Added ${c} new albums, skipped ${d} duplicates`):m(`Added ${c} albums to "${$}"`)}catch(s){console.error("Import merge error:",s),m("Error merging lists","error")}M=null,$=null}},document.getElementById("importCancelBtn").onclick=()=>{e.classList.add("hidden"),M=null,$=null,m("Import cancelled")},document.getElementById("confirmImportRenameBtn").onclick=async()=>{const s=o.value.trim();if(!s){m("Please enter a new name","error");return}if(y[s]){m("A list with this name already exists","error");return}n.classList.add("hidden");try{await S(s,M),G(),k(s),m(`Imported as "${s}" with ${M.length} albums`)}catch(a){console.error("Import with rename error:",a),m("Error importing list","error")}M=null,$=null},document.getElementById("cancelImportRenameBtn").onclick=()=>{n.classList.add("hidden"),document.getElementById("conflictListName").textContent=$,e.classList.remove("hidden")},o.onkeypress=s=>{s.key==="Enter"&&document.getElementById("confirmImportRenameBtn").click()}}function Et(e,n){if(e.querySelector("input"))return;const t=y[h][n].country||"",r=document.createElement("input");r.type="text",r.className="w-full bg-gray-800 text-gray-300 text-sm p-1 rounded border border-gray-700 focus:outline-none focus:border-red-600",r.value=t,r.placeholder="Type to search countries...",r.setAttribute("list",`country-list-${h}-${n}`);const o=document.createElement("datalist");o.id=`country-list-${h}-${n}`,R.forEach(c=>{const d=document.createElement("option");d.value=c,o.appendChild(d)});const s=e.onclick;e.onclick=null,e.innerHTML="",e.appendChild(r),e.appendChild(o),r.focus(),r.select();let a;const i=c=>{a&&(document.removeEventListener("click",a),a=null),e.innerHTML=`<span class="text-sm text-gray-300 truncate cursor-pointer hover:text-gray-100">${c}</span>`,e.onclick=s},l=async c=>{if(c=c.trim(),c===t){i(t);return}y[h][n].country=c;try{await S(h,y[h]),i(c),m(c===""?"Country cleared":"Country updated")}catch{m("Error saving country","error"),y[h][n].country=t,i(t)}};r.addEventListener("change",c=>{l(c.target.value)}),r.addEventListener("blur",()=>{l(r.value)}),r.addEventListener("keydown",c=>{c.key==="Enter"?(c.preventDefault(),l(r.value)):c.key==="Escape"&&(c.preventDefault(),i(t))}),a=c=>{e.contains(c.target)||l(r.value)},setTimeout(()=>{document.addEventListener("click",a)},100)}async function Lt(){try{if(F=(await(await fetch("/genres.txt")).text()).split(`
`).map(t=>t.trim()).filter((t,r,o)=>t.length>0||r===0&&t===""),F[0]!=="")F.sort();else{const t=F.shift();F.sort(),F.unshift(t)}}catch(e){console.error("Error loading genres:",e),m("Error loading genres","error")}}function m(e,n="success"){const t=document.getElementById("toast");t.textContent=e,t.className="toast "+n,setTimeout(()=>t.classList.add("show"),10),setTimeout(()=>{t.classList.remove("show")},3e3)}async function Q(e,n={}){try{const t=await fetch(e,{...n,headers:{"Content-Type":"application/json",...n.headers},credentials:"same-origin"});if(!t.ok){if(t.status===401){window.location.href="/login";return}throw new Error(`HTTP error! status: ${t.status}`)}return await t.json()}catch(t){throw console.error("API call failed:",t),t}}async function Ct(e){try{return await Q(`/api/unfurl?url=${encodeURIComponent(e)}`)}catch(n){return console.error("Link preview error:",n),null}}function ke(e,n){const t=n&&n.match(/https?:\/\/\S+/);if(!t)return;const r=t[0],o=document.createElement("div");o.className="mt-2 text-xs bg-gray-800 rounded",o.textContent="Loading preview...",e.appendChild(o),Ct(r).then(s=>{if(!s){o.remove();return}const a=s.image?`<img src="${s.image}" class="w-12 h-12 object-cover rounded flex-shrink-0" alt="">`:"",i=s.description?`<div class="text-gray-400 truncate">${s.description}</div>`:"";o.innerHTML=`<a href="${r}" target="_blank" class="flex gap-2 p-2 items-center">${a}<div class="min-w-0"><div class="font-semibold text-gray-100 truncate">${s.title||r}</div>${i}</div></a>`}).catch(()=>o.remove())}async function _e(){try{y=await Q("/api/lists"),G()}catch{m("Error loading lists","error")}}async function S(e,n){try{const t=n.map(r=>{const o={...r};return delete o.points,delete o.rank,o});console.debug("saveList",e,t),await Q(`/api/lists/${encodeURIComponent(e)}`,{method:"POST",body:JSON.stringify({data:t})}),y[e]=t}catch(t){throw m("Error saving list","error"),t}}function At(e){W&&(W.close(),W=null),e&&(W=new EventSource(`/api/lists/subscribe/${encodeURIComponent(e)}`,{withCredentials:!0}),W.addEventListener("update",n=>{try{const t=JSON.parse(n.data);y[e]=t,h===e&&Ee(t)}catch(t){console.error("Failed to parse SSE update",t)}}),W.onerror=n=>{console.error("SSE error",n)})}function It(){const e=document.getElementById("contextMenu"),n=document.getElementById("downloadListOption"),t=document.getElementById("renameListOption"),r=document.getElementById("deleteListOption");!e||!r||!t||!n||(n.onclick=()=>{e.classList.add("hidden"),T&&(wt(T),T=null)},t.onclick=()=>{e.classList.add("hidden"),T&&Tt(T)},r.onclick=async()=>{if(e.classList.add("hidden"),!!T){if(confirm(`Are you sure you want to delete the list "${T}"? This cannot be undone.`))try{if(await Q(`/api/lists/${encodeURIComponent(T)}`,{method:"DELETE"}),delete y[T],h===T){h=null;const o=document.getElementById("headerSeparator"),s=document.getElementById("headerListName"),a=document.getElementById("headerAddAlbumBtn");o&&s&&a&&(o.classList.add("hidden"),s.classList.add("hidden"),a.classList.add("hidden")),document.getElementById("albumContainer").innerHTML=`
            <div class="text-center text-gray-500 mt-20">
              <p class="text-xl mb-2">No list selected</p>
              <p class="text-sm">Create or import a list to get started</p>
            </div>
          `}G(),m(`List "${T}" deleted`)}catch(o){console.error("Error deleting list:",o),m("Error deleting list","error")}T=null}})}function $t(){const e=document.getElementById("dynamicHeader");e&&window.currentUser&&(e.innerHTML=window.headerComponent(window.currentUser,"home",h||""))}function kt(){const e=document.getElementById("albumContextMenu"),n=document.getElementById("removeAlbumOption"),t=document.getElementById("editAlbumOption"),r=document.getElementById("playAlbumOption");!e||!n||!t||!r||(t.onclick=()=>{e.classList.add("hidden"),O!==null&&showMobileEditForm(O)},r.onclick=()=>{e.classList.add("hidden"),O!==null&&St(O)},n.onclick=async()=>{if(e.classList.add("hidden"),O===null)return;const o=y[h][O];yt("Remove Album",`Remove "${o.album}" by ${o.artist}?`,"This will remove the album from this list.","Remove",async()=>{try{y[h].splice(O,1),await S(h,y[h]),k(h),m(`Removed "${o.album}" from the list`)}catch(s){console.error("Error removing album:",s),m("Error removing album","error"),await _e(),k(h)}O=null})})}function St(e){const n=y[h][e];if(!n)return;const t=window.currentUser?.spotifyAuth,r=window.currentUser?.tidalAuth;(t&&r?vt(!0,!0):t?Promise.resolve("spotify"):r?Promise.resolve("tidal"):(m("No music service connected","error"),Promise.resolve(null))).then(s=>{if(ie(),!s)return;const a=`artist=${encodeURIComponent(n.artist)}&album=${encodeURIComponent(n.album)}`;fetch(`${s==="spotify"?"/api/spotify/album":"/api/tidal/album"}?${a}`,{credentials:"include"}).then(async l=>{let c;try{c=await l.json()}catch{throw new Error("Invalid response")}if(!l.ok)throw new Error(c.error||"Request failed");return c}).then(l=>{l.id?s==="spotify"?window.location.href=`spotify:album:${l.id}`:window.location.href=`tidal://album/${l.id}`:l.error?m(l.error,"error"):m("Album not found on "+s,"error")}).catch(l=>{console.error("Play album error:",l),m(l.message||"Failed to open album","error")})})}function Bt(){const e=document.getElementById("createListBtn"),n=document.getElementById("createListModal"),t=document.getElementById("newListName"),r=document.getElementById("cancelCreateBtn"),o=document.getElementById("confirmCreateBtn");if(!e||!n)return;e.onclick=()=>{n.classList.remove("hidden"),t.value="",t.focus()};const s=()=>{n.classList.add("hidden"),t.value=""};r.onclick=s,n.onclick=i=>{i.target===n&&s()};const a=async()=>{const i=t.value.trim();if(!i){m("Please enter a list name","error"),t.focus();return}if(y[i]){m("A list with this name already exists","error"),t.focus();return}try{await S(i,[]),G(),k(i),s(),m(`Created list "${i}"`)}catch(l){console.error("Error creating list:",l),m("Error creating list","error")}};o.onclick=a,t.onkeypress=i=>{i.key==="Enter"&&a()},document.addEventListener("keydown",i=>{i.key==="Escape"&&!n.classList.contains("hidden")&&s()})}function Mt(){const e=document.getElementById("renameListModal"),n=document.getElementById("currentListName"),t=document.getElementById("newListNameInput"),r=document.getElementById("cancelRenameBtn"),o=document.getElementById("confirmRenameBtn");if(!e)return;const s=()=>{e.classList.add("hidden"),t.value=""};r.onclick=s,e.onclick=i=>{i.target===e&&s()};const a=async()=>{const i=n.textContent,l=t.value.trim();if(!l){m("Please enter a new list name","error"),t.focus();return}if(l===i){m("New name must be different from current name","error"),t.focus();return}if(y[l]){m("A list with this name already exists","error"),t.focus();return}try{const c=y[i];await S(l,c),await Q(`/api/lists/${encodeURIComponent(i)}`,{method:"DELETE"}),delete y[i],h===i&&(h=l,k(l)),G(),s(),m(`List renamed from "${i}" to "${l}"`)}catch(c){console.error("Error renaming list:",c),m("Error renaming list","error")}};o.onclick=a,t.onkeypress=i=>{i.key==="Enter"&&a()}}function Tt(e){const n=document.getElementById("renameListModal"),t=document.getElementById("currentListName"),r=document.getElementById("newListNameInput");!n||!t||!r||(t.textContent=e,r.value=e,n.classList.remove("hidden"),setTimeout(()=>{r.focus(),r.select()},100))}function G(){const e=document.getElementById("listNav"),n=document.getElementById("mobileListNav"),t=(r,o=!1)=>{r.innerHTML="",Object.keys(y).forEach(s=>{const a=document.createElement("li");a.innerHTML=`
        <button class="w-full text-left px-3 py-${o?"3":"2"} rounded text-sm hover:bg-gray-800 transition duration-200 ${h===s?"bg-gray-800 text-red-500":"text-gray-300"} flex items-center">
          <i class="fas fa-list mr-2 flex-shrink-0"></i>
          <span class="truncate">${s}</span>
        </button>
      `;const i=a.querySelector("button");if(!o)i.addEventListener("contextmenu",l=>{l.preventDefault(),l.stopPropagation(),T=s;const c=document.getElementById("contextMenu");c&&(c.style.left=`${l.clientX}px`,c.style.top=`${l.clientY}px`,c.classList.remove("hidden"),setTimeout(()=>{const d=c.getBoundingClientRect();d.right>window.innerWidth&&(c.style.left=`${l.clientX-d.width}px`),d.bottom>window.innerHeight&&(c.style.top=`${l.clientY-d.height}px`)},0))});else{let l;i.addEventListener("touchstart",c=>{l=setTimeout(()=>{showMobileListMenu(s)},500)},{passive:!0}),i.addEventListener("touchend",()=>clearTimeout(l),{passive:!0})}i.onclick=()=>{k(s),o&&toggleMobileLists()},r.appendChild(a)})};t(e),n&&t(n,!0)}function Dt(e){if(!window.Sortable){console.error("SortableJS not loaded");return}e._sortable&&e._sortable.destroy();const n=e.querySelector(".mobile-album-list")||e;let t=n.closest(".overflow-y-auto");if(!t){const f=document.querySelector("#mobileAlbumContainer");f&&(t=f.parentElement)}const r=()=>{const f=document.querySelector("nav.fixed.bottom-0");return f&&!f.classList.contains("hidden")?f.offsetHeight:0},o=()=>{if(t){const f=t.scrollTop,x=t.scrollHeight;t.offsetHeight,f+t.clientHeight>=x-200&&(n.style.minHeight=n.scrollHeight+"px",requestAnimationFrame(()=>{n.style.minHeight=""}))}};let s=null,a=0,i=null,l=1;const c=(f,x)=>{s&&clearInterval(s),a=x,l=1,s=setInterval(()=>{if(t){l<2.5&&(l+=.05);const w=a*l,N=t.scrollTop+f*w;if(f>0){const H=t.scrollHeight-t.clientHeight;t.scrollTop=Math.min(N,H),t.scrollTop>=H&&d()}else t.scrollTop=Math.max(N,0),t.scrollTop<=0&&d();o()}},16)},d=()=>{s&&(clearInterval(s),s=null,a=0,l=1)},g=Sortable.create(n,{animation:150,handle:".drag-handle",preventOnFilter:!0,forceFallback:!0,fallbackClass:"sortable-drag",ghostClass:"sortable-ghost",chosenClass:"sortable-chosen",dragClass:"sortable-drag",delay:0,delayOnTouchOnly:!1,touchStartThreshold:0,scroll:!1,onStart:function(f){f.item.dataset.originalIndex=f.oldIndex,document.body.style.overflow="hidden",document.body.classList.add("sorting-active"),i=null,t&&(t.classList.add("sortable-scrolling"),t.classList.add("sortable-drag-active"),n.querySelectorAll(".album-card").forEach(w=>{w.offsetHeight}))},onMove:function(f){if(!t)return;const w=(f.originalEvent.touches?f.originalEvent.touches[0]:f.originalEvent).clientY;i=w;const I=window.innerHeight,N=t.getBoundingClientRect(),H=Math.max(100,I*.25),B=Math.max(N.top,0),p=Math.min(N.bottom,I),v=B+H,E=p-H;let b=!1,C=0,A=0;if(w<v&&w>=B){b=!0,C=-1;const L=(v-w)/H;A=Math.max(3,Math.min(25,L*25)),w<B+30&&(A=Math.min(35,A*1.5))}else if(w>E&&w<=p){b=!0,C=1;const L=(w-E)/H;A=Math.max(3,Math.min(25,L*25)),w>p-30&&(A=Math.min(35,A*1.5))}b?c(C,A):d(),o()},onEnd:function(f){d(),document.body.style.overflow="",document.body.classList.remove("sorting-active"),i=null,t&&(t.classList.remove("sortable-scrolling"),t.classList.remove("sortable-drag-active"))},onUpdate:async function(f){const x=parseInt(f.item.dataset.originalIndex),w=f.newIndex;if(x!==w)try{const I=y[h],[N]=I.splice(x,1);I.splice(w,0,N),await S(h,I),n.querySelectorAll(".album-card").forEach((B,p)=>{B.dataset.index=p;const v=B.querySelector(".w-12.flex.items-center.justify-center");v&&(v.textContent=p+1)})}catch(I){console.error("Error saving reorder:",I),m("Error saving changes","error"),k(h)}}});e._sortable=g}async function k(e){try{if(console.log("Selecting list:",e),h=e,At(e),e)try{const t=await Q(`/api/lists/${encodeURIComponent(e)}`);y[e]=t}catch(t){console.warn("Failed to fetch latest list data:",t)}e&&localStorage.setItem("lastSelectedList",e);try{await Q("/api/user/last-list",{method:"POST",body:JSON.stringify({listName:e})})}catch(t){console.warn("Failed to save list preference:",t)}$t(),G(),Rt(e),Ee(y[e]);const n=document.getElementById("addAlbumFAB");n&&(n.style.display=e?"flex":"none")}catch(n){console.error("Error selecting list:",n),m("Error loading list","error")}}function Rt(e){const n=document.getElementById("headerSeparator"),t=document.getElementById("headerListName"),r=document.getElementById("headerAddAlbumBtn");e&&n&&t&&(n.classList.remove("hidden"),t.classList.remove("hidden"),t.textContent=e,r&&r.classList.remove("hidden"))}function Se(e,n,t){if(e.querySelector("input"))return;const r=y[h][n][t]||"",o=document.createElement("input");o.type="text",o.className="w-full bg-gray-800 text-gray-300 text-sm p-1 rounded border border-gray-700 focus:outline-none focus:border-red-600",o.value=r,o.placeholder=`Type to search ${t==="genre_1"?"primary":"secondary"} genre...`,o.setAttribute("list",`genre-list-${h}-${n}-${t}`);const s=document.createElement("datalist");s.id=`genre-list-${h}-${n}-${t}`,F.forEach(d=>{const g=document.createElement("option");g.value=d,s.appendChild(g)});const a=e.onclick;e.onclick=null,e.innerHTML="",e.appendChild(o),e.appendChild(s),o.focus(),o.select();let i;const l=d=>{i&&(document.removeEventListener("click",i),i=null);const g=t==="genre_1"?"text-gray-300":"text-gray-400";let f=d;t==="genre_2"&&(f==="Genre 2"||f==="-"||f==="")&&(f=""),e.innerHTML=`<span class="text-sm ${g} truncate cursor-pointer hover:text-gray-100">${f}</span>`,e.onclick=a},c=async d=>{if(d=d.trim(),d===r){l(r);return}y[h][n][t]=d;try{await S(h,y[h]),l(d),m(d===""?"Genre cleared":"Genre updated")}catch{m("Error saving genre","error"),y[h][n][t]=r,l(r)}};o.addEventListener("change",d=>{c(d.target.value)}),o.addEventListener("blur",()=>{c(o.value)}),o.addEventListener("keydown",d=>{d.key==="Enter"?(d.preventDefault(),c(o.value)):d.key==="Escape"&&(d.preventDefault(),l(r))}),i=d=>{e.contains(d.target)||c(o.value)},setTimeout(()=>{document.addEventListener("click",i)},100)}function de(e,n){const t=y[h][n].comments||y[h][n].comment||"",r=document.createElement("textarea");r.className="w-full bg-gray-800 text-gray-300 text-sm p-2 rounded border border-gray-700 focus:outline-none focus:border-red-600 resize-none",r.value=t,r.rows=2,e.innerHTML="",e.appendChild(r),r.focus(),r.select();const o=async()=>{const s=r.value.trim();y[h][n].comments=s,y[h][n].comment=s;try{await S(h,y[h]);let a=s;a==="Comment"&&(a=""),e.innerHTML=`<span class="text-sm text-gray-300 italic line-clamp-2 cursor-pointer hover:text-gray-100">${a}</span>`,e.onclick=()=>de(e,n),s!==t&&m("Comment updated")}catch{m("Error saving comment","error"),e.innerHTML=`<span class="text-sm text-gray-300 italic line-clamp-2 cursor-pointer hover:text-gray-100">${t}</span>`,e.onclick=()=>de(e,n)}};r.addEventListener("blur",o),r.addEventListener("keydown",s=>{if(s.key==="Enter"&&!s.shiftKey&&(s.preventDefault(),r.blur()),s.key==="Escape"){let a=t;a==="Comment"&&(a=""),e.innerHTML=`<span class="text-sm text-gray-300 italic line-clamp-2 cursor-pointer hover:text-gray-100">${a}</span>`,e.onclick=()=>de(e,n)}})}function Ee(e){console.log("displayAlbums called, mobile:",window.innerWidth<1024,"albums:",e?.length);const n=window.innerWidth<1024,t=document.getElementById("albumContainer");if(console.log("Container found:",!!t,"Container ID:",t?.id),!t){console.error("Album container not found!");return}if(t.innerHTML="",console.log("Container cleared, about to add albums..."),!e||e.length===0){t.innerHTML=`
      <div class="text-center text-gray-500 mt-20 px-4">
        <p class="text-xl mb-2">This list is empty</p>
        <p class="text-sm">Click the + button to add albums${n?"":" or use the Add Album button"}</p>
      </div>
    `;return}if(n){console.log("Building mobile view for",e.length,"albums");const r=document.createElement("div");r.className="mobile-album-list pb-20",e.forEach((o,s)=>{const a=document.createElement("div");a.className="album-card-wrapper";const i=document.createElement("div");i.className="album-card bg-gray-900 border-b border-gray-800 touch-manipulation transition-all cursor-move relative overflow-hidden",i.dataset.index=s;const l=o.album||"Unknown Album",c=o.artist||"Unknown Artist",d=me(o.release_date||""),g=o.country||"",f=o.genre_1||o.genre||"";let x=o.genre_2||"";(x==="Genre 2"||x==="-")&&(x="");let w=o.comments||o.comment||"";w==="Comment"&&(w=""),i.innerHTML=`
        <div class="flex items-center h-full">
          <!-- Position number on the far left -->
          <div class="flex-shrink-0 w-12 flex items-center justify-center text-gray-500 font-medium text-sm">
            ${s+1}
          </div>
          
          <!-- Album cover -->
          <div class="flex-shrink-0 p-3 pl-0">
            ${o.cover_image?`
              <img src="data:image/${o.cover_image_format||"PNG"};base64,${o.cover_image}" 
                  alt="${l}" 
                  class="w-16 h-16 rounded-lg object-cover shadow-md"
                  loading="lazy">
            `:`
              <div class="w-16 h-16 bg-gray-800 rounded-lg shadow-md flex items-center justify-center">
                <i class="fas fa-compact-disc text-xl text-gray-600"></i>
              </div>
            `}
          </div>
          
          <!-- Main content -->
          <div class="flex-1 min-w-0 py-3 pr-3">
            <div class="flex items-start justify-between gap-2">
              <div class="flex-1 min-w-0">
                <h3 class="font-semibold text-white text-base leading-tight truncate">${l}</h3>
                <p class="text-sm text-gray-400 truncate mt-0.5">${c}</p>
                
                <!-- Date and Country row -->
                <div class="flex items-center gap-2 mt-1 text-xs text-gray-500">
                  <span class="whitespace-nowrap">${d}</span>
                  ${g?`<span>\u2022 ${g}</span>`:""}
                </div>
                
                <!-- Genres row (if any) -->
                ${f||x?`
                  <div class="text-xs text-gray-500 truncate">
                    ${f}${x?` / ${x}`:""}
                  </div>
                `:""}
                
                ${w?`
                  <p class="text-xs text-gray-400 italic mt-1 line-clamp-1">${w}</p>
                `:""}
              </div>
              
              <!-- Actions on the right -->
              <button onclick="event.stopPropagation(); showMobileAlbumMenu(this)"
                      class="flex-shrink-0 p-2 -m-2 text-gray-400 active:text-gray-200">
                <i class="fas fa-ellipsis-v"></i>
              </button>
            </div>
          </div>
          
          <!-- Subtle drag handle on far right edge -->
          <div class="drag-handle flex-shrink-0 w-8 h-full flex items-center justify-center cursor-move select-none text-gray-600 border-l border-gray-800/50" 
              style="touch-action: none; -webkit-user-select: none; -webkit-touch-callout: none;">
            <svg width="16" height="24" viewBox="0 0 16 24" fill="none" class="pointer-events-none opacity-50">
              <circle cx="5" cy="6" r="1.5" fill="currentColor"/>
              <circle cx="5" cy="12" r="1.5" fill="currentColor"/>
              <circle cx="5" cy="18" r="1.5" fill="currentColor"/>
              <circle cx="11" cy="6" r="1.5" fill="currentColor"/>
              <circle cx="11" cy="12" r="1.5" fill="currentColor"/>
              <circle cx="11" cy="18" r="1.5" fill="currentColor"/>
            </svg>
          </div>
        </div>
      `,a.appendChild(i);const I=i.querySelector(".flex-1.min-w-0");I&&ke(I,w),r.appendChild(a)}),t.appendChild(r),console.log("Mobile container appended with",e.length,"albums"),Dt(r)}else{const r=document.createElement("div");r.className="w-full relative";const o=document.createElement("div");o.className="album-grid gap-4 px-4 py-2 text-xs font-semibold uppercase tracking-wider text-gray-400 border-b border-gray-800 sticky top-0 bg-black z-10",o.style.alignItems="center",o.innerHTML=`
      <div class="text-center">#</div>
      <div></div>
      <div>Album</div>
      <div>Artist</div>
      <div>Country</div>
      <div>Genre 1</div>
      <div>Genre 2</div>
      <div>Comment</div>
    `,r.appendChild(o);const s=document.createElement("div");s.className="album-rows-container relative",e.forEach((a,i)=>{const l=document.createElement("div");l.className="album-row album-grid gap-4 px-4 py-2 border-b border-gray-800 cursor-move hover:bg-gray-800/30 transition-colors",l.dataset.index=i;const c=i+1,d=a.album||"Unknown Album",g=a.artist||"Unknown Artist",f=a.country||"",x=f||"Country",w=f?"text-gray-300":"text-gray-500 italic",I=a.genre_1||a.genre||"",N=I||"Genre 1",H=I?"text-gray-300":"text-gray-500 italic";let B=a.genre_2||"";(B==="Genre 2"||B==="-")&&(B="");const p=B||"Genre 2",v=B?"text-gray-400":"text-gray-500 italic";let E=a.comments||a.comment||"";E==="Comment"&&(E="");const b=me(a.release_date||""),C=a.cover_image||"",A=a.cover_image_format||"PNG";l.innerHTML=`
        <div class="flex items-center justify-center text-gray-400 font-medium">${c}</div>
        <div class="flex items-center">
          <div class="album-cover-container">
            ${C?`
              <img src="data:image/${A};base64,${C}" 
                  alt="${d}" 
                  class="album-cover rounded shadow-lg"
                  loading="lazy"
                  onerror="this.onerror=null; this.parentElement.innerHTML='<div class=\\'album-cover-placeholder rounded bg-gray-800 shadow-lg\\'><svg width=\\'24\\' height=\\'24\\' viewBox=\\'0 0 24 24\\' fill=\\'none\\' stroke=\\'currentColor\\' stroke-width=\\'2\\' class=\\'text-gray-600\\'><rect x=\\'3\\' y=\\'3\\' width=\\'18\\' height=\\'18\\' rx=\\'2\\' ry=\\'2\\'></rect><circle cx=\\'8.5\\' cy=\\'8.5\\' r=\\'1.5\\'></circle><polyline points=\\'21 15 16 10 5 21\\'></polyline></svg></div>'"
              >
            `:`
              <div class="album-cover-placeholder rounded bg-gray-800 shadow-lg">
                <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" class="text-gray-600">
                  <rect x="3" y="3" width="18" height="18" rx="2" ry="2"></rect>
                  <circle cx="8.5" cy="8.5" r="1.5"></circle>
                  <polyline points="21 15 16 10 5 21"></polyline>
                </svg>
              </div>
            `}
          </div>
        </div>
        <div class="flex flex-col justify-center min-w-0">
          <div class="font-medium text-white truncate">${d}</div>
          <div class="text-xs text-gray-400">${b}</div>
        </div>
        <div class="flex items-center text-gray-300 truncate">${g}</div>
        <div class="flex items-center country-cell">
          <span class="text-sm ${w} truncate cursor-pointer hover:text-gray-100">${x}</span>
        </div>
        <div class="flex items-center genre-cell genre-1-cell">
          <span class="text-sm ${H} truncate cursor-pointer hover:text-gray-100">${N}</span>
        </div>
        <div class="flex items-center genre-cell genre-2-cell">
          <span class="text-sm ${v} truncate cursor-pointer hover:text-gray-100">${p}</span>
        </div>
        <div class="flex items-center comment-cell">
          <span class="text-sm text-gray-300 italic line-clamp-2 cursor-pointer hover:text-gray-100">${E}</span>
        </div>
      `;const L=l.querySelector(".country-cell");L.onclick=()=>Et(L,i);const _=l.querySelector(".genre-1-cell");_.onclick=()=>Se(_,i,"genre_1");const ee=l.querySelector(".genre-2-cell");ee.onclick=()=>Se(ee,i,"genre_2");const te=l.querySelector(".comment-cell");te.onclick=()=>de(te,i),ke(te,E),window.DragDropManager&&window.DragDropManager.makeRowDraggable(l),l.addEventListener("contextmenu",z=>{z.preventDefault(),z.stopPropagation(),O=i;const P=document.getElementById("albumContextMenu");P&&(P.style.left=`${z.clientX}px`,P.style.top=`${z.clientY}px`,P.classList.remove("hidden"),setTimeout(()=>{const Y=P.getBoundingClientRect();Y.right>window.innerWidth&&(P.style.left=`${z.clientX-Y.width}px`),Y.bottom>window.innerHeight&&(P.style.top=`${z.clientY-Y.height}px`)},0))}),s.appendChild(l)}),r.appendChild(s),t.appendChild(r),window.DragDropManager&&(window.DragDropManager.initialize(),window.DragDropManager.setupDropHandler(async(a,i,l)=>{if(console.debug("Drop handler invoked",{draggedIndex:a,dropIndex:i,needsRebuild:l}),l){Ee(y[h]);return}if(a!==null&&i!==null){console.debug("Reordering list",{list:h,from:a,to:i});const c=y[h],[d]=c.splice(a,1);c.splice(i,0,d),await S(h,c)}}))}console.log("displayAlbums completed")}window.showMobileAlbumMenu=function(e){let n=e;if(typeof e!="number"){const o=e.closest(".album-card");if(!o)return;n=parseInt(o.dataset.index)}const t=y[h][n],r=document.createElement("div");r.className="fixed inset-0 z-50 lg:hidden",r.innerHTML=`
    <div class="absolute inset-0 bg-black bg-opacity-50" onclick="this.parentElement.remove()"></div>
    <div class="absolute bottom-0 left-0 right-0 bg-gray-900 rounded-t-2xl safe-area-bottom">
      <div class="p-4">
        <div class="w-12 h-1 bg-gray-600 rounded-full mx-auto mb-4"></div>
        <h3 class="font-semibold text-white mb-1 truncate">${t.album}</h3>
        <p class="text-sm text-gray-400 mb-4 truncate">${t.artist}</p>
        
        <button onclick="showMobileEditForm(${n}); this.closest('.fixed').remove();"
                class="w-full text-left py-3 px-4 hover:bg-gray-800 rounded">
          <i class="fas fa-edit mr-3 text-gray-400"></i>Edit Details
        </button>

        <button onclick="this.closest('.fixed').remove(); playAlbum(${n});"
                class="w-full text-left py-3 px-4 hover:bg-gray-800 rounded">
          <i class="fas fa-play mr-3 text-gray-400"></i>Play Album
        </button>

        <button onclick="this.closest('.fixed').remove(); setTimeout(() => { currentContextAlbum = ${n}; document.getElementById('removeAlbumOption').click(); }, 100);"
                class="w-full text-left py-3 px-4 hover:bg-gray-800 rounded text-red-500">
          <i class="fas fa-trash mr-3"></i>Remove from List
        </button>
        
        <button onclick="this.closest('.fixed').remove()" 
                class="w-full text-center py-3 px-4 mt-2 bg-gray-800 rounded">
          Cancel
        </button>
      </div>
    </div>
  `,document.body.appendChild(r)};window.showMobileEditForm=function(e){const n=y[h][e],t=document.createElement("div");t.className="fixed inset-0 z-50 bg-gray-900 flex flex-col overflow-hidden lg:max-w-2xl lg:mx-auto lg:my-8 lg:rounded-lg lg:shadow-2xl",t.innerHTML=`
    <!-- Header -->
    <div class="flex items-center justify-between p-4 border-b border-gray-800 flex-shrink-0">
      <button onclick="this.closest('.fixed').remove()" class="p-2 -m-2 text-gray-400 hover:text-white">
        <i class="fas fa-times text-xl"></i>
      </button>
      <h3 class="text-lg font-semibold text-white flex-1 text-center px-4">Edit Album</h3>
      <button id="mobileEditSaveBtn" class="text-red-500 font-semibold whitespace-nowrap">Save</button>
    </div>
    
    <!-- Form Content -->
    <div class="flex-1 overflow-y-auto overflow-x-hidden -webkit-overflow-scrolling-touch">
      <form id="mobileEditForm" class="p-4 space-y-4 max-w-full">
        <!-- Album Cover Preview -->
        ${n.cover_image?`
          <div class="flex justify-center mb-4">
            <img src="data:image/${n.cover_image_format||"PNG"};base64,${n.cover_image}" 
                 alt="${n.album}" 
                 class="w-32 h-32 rounded-lg object-cover shadow-md">
          </div>
        `:""}
        
        <!-- Artist Name -->
        <div class="w-full">
          <label class="block text-gray-400 text-sm mb-2">Artist</label>
          <input 
            type="text" 
            id="editArtist" 
            value="${n.artist||""}"
            class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-red-600 transition duration-200"
            placeholder="Artist name"
          >
        </div>
        
        <!-- Album Title -->
        <div class="w-full">
          <label class="block text-gray-400 text-sm mb-2">Album</label>
          <input 
            type="text" 
            id="editAlbum" 
            value="${n.album||""}"
            class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-red-600 transition duration-200"
            placeholder="Album title"
          >
        </div>
        
        <!-- Release Date -->
        <div class="w-full">
          <label class="block text-gray-400 text-sm mb-2">Release Date</label>
          <input 
            type="date" 
            id="editReleaseDate" 
            value="${n.release_date?n.release_date.length===4?n.release_date+"-01-01":n.release_date:new Date().toISOString().split("T")[0]}"
            class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-red-600 transition duration-200"
            style="display: block; width: 100%; min-height: 48px; -webkit-appearance: none;"
          >
          ${n.release_date?"":'<p class="text-xs text-gray-500 mt-1">No date set - defaulting to today</p>'}
        </div>
        
        <!-- Country - Native Select -->
        <div class="w-full">
          <label class="block text-gray-400 text-sm mb-2">Country</label>
          <div class="relative">
            <select 
              id="editCountry" 
              class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-red-600 transition duration-200 appearance-none pr-10"
            >
              <option value="">Select a country...</option>
              ${R.map(s=>`<option value="${s}" ${s===n.country?"selected":""}>${s}</option>`).join("")}
            </select>
            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
              <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
          </div>
        </div>
        
        <!-- Genre 1 - Native Select -->
        <div class="w-full">
          <label class="block text-gray-400 text-sm mb-2">Primary Genre</label>
          <div class="relative">
            <select 
              id="editGenre1" 
              class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-red-600 transition duration-200 appearance-none pr-10"
            >
              <option value="">Select a genre...</option>
              ${F.map(s=>`<option value="${s}" ${s===(n.genre_1||n.genre)?"selected":""}>${s}</option>`).join("")}
            </select>
            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
              <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
          </div>
        </div>
        
        <!-- Genre 2 - Native Select -->
        <div class="w-full">
          <label class="block text-gray-400 text-sm mb-2">Secondary Genre</label>
          <div class="relative">
            <select 
              id="editGenre2" 
              class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white focus:outline-none focus:border-red-600 transition duration-200 appearance-none pr-10"
            >
              <option value="">None (optional)</option>
              ${F.map(s=>{const a=n.genre_2&&n.genre_2!=="Genre 2"&&n.genre_2!=="-"?n.genre_2:"";return`<option value="${s}" ${s===a?"selected":""}>${s}</option>`}).join("")}
            </select>
            <div class="absolute inset-y-0 right-0 flex items-center pr-3 pointer-events-none">
              <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
              </svg>
            </div>
          </div>
        </div>
        
        <!-- Comments -->
        <div class="w-full">
          <label class="block text-gray-400 text-sm mb-2">Comments</label>
          <textarea 
            id="editComments" 
            rows="3"
            class="w-full px-4 py-3 bg-gray-800 border border-gray-700 rounded-lg text-white placeholder-gray-500 focus:outline-none focus:border-red-600 transition duration-200 resize-none"
            placeholder="Add your notes..."
          >${n.comments||n.comment||""}</textarea>
        </div>
        
        <!-- Spacer for bottom padding -->
        <div class="h-4"></div>
      </form>
    </div>
  `,document.body.appendChild(t);const r=document.getElementById("editReleaseDate"),o=document.getElementById("datePlaceholder");r&&o&&(r.addEventListener("focus",()=>{o.style.display="none"}),r.addEventListener("blur",()=>{r.value||(o.style.display="flex")}),r.addEventListener("change",()=>{r.value&&(o.style.display="none")})),document.getElementById("mobileEditSaveBtn").onclick=async function(){const s={...n,artist:document.getElementById("editArtist").value.trim(),album:document.getElementById("editAlbum").value.trim(),release_date:document.getElementById("editReleaseDate").value,country:document.getElementById("editCountry").value,genre_1:document.getElementById("editGenre1").value,genre:document.getElementById("editGenre1").value,genre_2:document.getElementById("editGenre2").value,comments:document.getElementById("editComments").value.trim(),comment:document.getElementById("editComments").value.trim()};if(!s.artist||!s.album){m("Artist and Album are required","error");return}y[h][e]=s;try{await S(h,y[h]),k(h),t.remove(),m("Album updated successfully")}catch(a){console.error("Error saving album:",a),m("Error saving changes","error"),y[h][e]=n}},setTimeout(()=>{document.getElementById("editArtist").focus()},100)};document.getElementById("importBtn").onclick=()=>{document.getElementById("fileInput").click()};document.getElementById("fileInput").onchange=async e=>{const n=e.target.files[0];if(n){const t=new FileReader;t.onload=async r=>{try{const o=r.target.result,s=JSON.parse(o);if(!Array.isArray(s))throw new Error("JSON must be an array of albums");if(s.length>0){const l=["artist","album"].filter(c=>!s[0].hasOwnProperty(c));if(l.length>0)throw new Error("Missing required fields: "+l.join(", "))}const a=n.name.replace(".json","");y[a]?(M=s,$=a,document.getElementById("conflictListName").textContent=a,document.getElementById("importConflictModal").classList.remove("hidden")):(await S(a,s),G(),k(a),m(`Successfully imported ${s.length} albums`))}catch(o){console.error("Import error:",o),m("Error importing file: "+o.message,"error")}},t.onerror=r=>{console.error("File read error:",r),m("Error reading file","error")},t.readAsText(n,"UTF-8")}e.target.value=""};document.addEventListener("DOMContentLoaded",()=>{function e(){const n=document.getElementById("sidebar"),t=document.getElementById("sidebarToggle"),r=document.querySelector(".main-content");if(!n||!t||!r)return;localStorage.getItem("sidebarCollapsed")==="true"&&(n.classList.add("collapsed"),r.classList.add("sidebar-collapsed")),t.addEventListener("click",()=>{n.classList.contains("collapsed")?(n.classList.remove("collapsed"),r.classList.remove("sidebar-collapsed"),localStorage.setItem("sidebarCollapsed","false")):(n.classList.add("collapsed"),r.classList.add("sidebar-collapsed"),localStorage.setItem("sidebarCollapsed","true"))})}e(),Promise.all([Lt(),bt(),_e()]).then(()=>{It(),kt(),Bt(),Mt(),xt();const n=localStorage.getItem("lastSelectedList"),t=window.lastSelectedList;n&&y[n]?(console.log("Auto-loading last selected list from localStorage:",n),k(n)):t&&y[t]&&(console.log("Auto-loading last selected list from server:",t),k(t),localStorage.setItem("lastSelectedList",t));const r=document.getElementById("confirmationModal"),o=document.getElementById("confirmationCancelBtn"),s=document.getElementById("confirmationConfirmBtn");r&&o&&s&&(o.onclick=ie,s.onclick=()=>{ue&&ue(),ie()},r.onclick=a=>{a.target===r&&ie()},document.addEventListener("keydown",a=>{a.key==="Escape"&&!r.classList.contains("hidden")&&ie()}))}).catch(n=>{console.error("Failed to initialize:",n),m("Failed to initialize","error")})});window.addEventListener("beforeunload",()=>{h&&localStorage.setItem("lastSelectedList",h),W&&W.close()});window.showToast=m;})();
