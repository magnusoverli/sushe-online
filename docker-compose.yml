services:
  app:
    build: .
    container_name: sushe-online
    ports:
      - '3000:3000'
    environment:
      - NODE_ENV=production
      - SESSION_SECRET=${SESSION_SECRET}
      - SENDGRID_API_KEY=${SENDGRID_API_KEY}
      - EMAIL_FROM=${EMAIL_FROM}
      - BASE_URL=${BASE_URL}
      - PORT=3000
      - DATA_DIR=/app/data
      - SPOTIFY_CLIENT_ID=${SPOTIFY_CLIENT_ID}
      - SPOTIFY_CLIENT_SECRET=${SPOTIFY_CLIENT_SECRET}
      - SPOTIFY_REDIRECT_URI=${SPOTIFY_REDIRECT_URI}
      - TIDAL_CLIENT_ID=${TIDAL_CLIENT_ID}
      - TIDAL_REDIRECT_URI=${TIDAL_REDIRECT_URI}
      - DATABASE_URL=postgres://postgres:example@/sushe?host=/var/run/postgresql
    volumes:
      - sushe-data:/app/data
      - postgres-socket:/var/run/postgresql
    depends_on:
      db:
        condition: service_healthy
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 512M
          cpus: '0.5'

  db:
    image: postgres:17
    ports:
      - '5433:5432' # Expose PostgreSQL for local development
    environment:
      POSTGRES_PASSWORD: example
      POSTGRES_DB: sushe
      # Enhanced logging for monitoring
      POSTGRES_INITDB_ARGS: '--auth-host=md5'
    volumes:
      - postgres-data:/var/lib/postgresql/data
      - postgres-socket:/var/run/postgresql
      - ./scripts/docker-entrypoint-upgrade.sh:/usr/local/bin/docker-entrypoint-upgrade.sh:ro
    entrypoint: ['/usr/local/bin/docker-entrypoint-upgrade.sh']
    healthcheck:
      test: ['CMD-SHELL', 'pg_isready -U postgres -d sushe']
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    restart: unless-stopped
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '4.0'
        reservations:
          memory: 1G
          cpus: '1.0'
    command: >
      postgres 
      -c log_destination=stderr 
      -c log_min_messages=error
      -c log_statement=none 
      -c log_duration=off 
      -c log_min_duration_statement=-1
      -c shared_buffers=1GB
      -c effective_cache_size=3GB
      -c maintenance_work_mem=256MB
      -c checkpoint_completion_target=0.9
      -c wal_buffers=64MB
      -c default_statistics_target=100
      -c random_page_cost=1.1
      -c effective_io_concurrency=200
      -c work_mem=16MB
      -c max_connections=100

volumes:
  sushe-data:
  postgres-data:
  postgres-socket:
